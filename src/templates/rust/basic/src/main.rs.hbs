use actix_web::{web, App, HttpServer, middleware::Logger};
use actix_cors::Cors;
use diesel::prelude::*;
use diesel::r2d2::{self, ConnectionManager};
use std::env;

mod config;
mod models;
mod schema;
mod handlers;
mod services;

use config::database::establish_connection;
use handlers::user_routes;

#[actix_web::main]
async fn main() -> std::io::Result<()> {
    env_logger::init();
    dotenv::dotenv().ok();

    // Database connection
    let conn_spec = establish_connection();
    
    println!("ðŸš€ {{pascalCase projectName}} server starting on 0.0.0.0:8080");

    HttpServer::new(move || {
        let cors = Cors::default()
            .allow_any_origin()
            .allow_any_method()
            .allow_any_header()
            .max_age(3600);

        App::new()
            .app_data(web::Data::new(conn_spec.clone()))
            .wrap(cors)
            .wrap(Logger::default())
            .service(
                web::scope("/api")
                    .configure(user_routes::config)
            )
            .route("/health", web::get().to(health_check))
    })
    .bind("0.0.0.0:8080")?
    .run()
    .await
}

async fn health_check() -> impl actix_web::Responder {
    actix_web::HttpResponse::Ok().json(serde_json::json!({
        "status": "OK",
        "timestamp": "2024-01-01T00:00:00Z"
    }))
}