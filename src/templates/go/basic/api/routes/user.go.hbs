package routes

import (
	"net/http"
	"strconv"

	"{{projectName}}/models"
	"{{projectName}}/services"

	"github.com/gin-gonic/gin"
)

func SetupRoutes(rg *gin.RouterGroup) {
	userService := services.NewUserService()
	
	users := rg.Group("/users")
	{
		users.GET("", GetUsers(userService))
		users.GET("/:id", GetUser(userService))
		users.POST("", CreateUser(userService))
		users.PUT("/:id", UpdateUser(userService))
		users.DELETE("/:id", DeleteUser(userService))
	}
}

func GetUsers(userService *services.UserService) gin.HandlerFunc {
	return func(c *gin.Context) {
		users, err := userService.GetAllUsers()
		if err != nil {
			c.JSON(http.StatusInternalServerError, gin.H{
				"success": false,
				"error":   gin.H{"message": "Failed to fetch users"},
			})
			return
		}

		c.JSON(http.StatusOK, gin.H{
			"success": true,
			"data":    users,
		})
	}
}

func GetUser(userService *services.UserService) gin.HandlerFunc {
	return func(c *gin.Context) {
		id := c.Param("id")
		
		user, err := userService.GetUserByID(id)
		if err != nil {
			c.JSON(http.StatusNotFound, gin.H{
				"success": false,
				"error":   gin.H{"message": "User not found"},
			})
			return
		}

		c.JSON(http.StatusOK, gin.H{
			"success": true,
			"data":    user,
		})
	}
}

func CreateUser(userService *services.UserService) gin.HandlerFunc {
	return func(c *gin.Context) {
		var user models.User
		if err := c.ShouldBindJSON(&user); err != nil {
			c.JSON(http.StatusBadRequest, gin.H{
				"success": false,
				"error":   gin.H{"message": "Invalid request body"},
			})
			return
		}

		createdUser, err := userService.CreateUser(&user)
		if err != nil {
			c.JSON(http.StatusInternalServerError, gin.H{
				"success": false,
				"error":   gin.H{"message": "Failed to create user"},
			})
			return
		}

		c.JSON(http.StatusCreated, gin.H{
			"success": true,
			"data":    createdUser,
		})
	}
}

func UpdateUser(userService *services.UserService) gin.HandlerFunc {
	return func(c *gin.Context) {
		id := c.Param("id")
		
		var user models.User
		if err := c.ShouldBindJSON(&user); err != nil {
			c.JSON(http.StatusBadRequest, gin.H{
				"success": false,
				"error":   gin.H{"message": "Invalid request body"},
			})
			return
		}

		updatedUser, err := userService.UpdateUser(id, &user)
		if err != nil {
			c.JSON(http.StatusNotFound, gin.H{
				"success": false,
				"error":   gin.H{"message": "User not found"},
			})
			return
		}

		c.JSON(http.StatusOK, gin.H{
			"success": true,
			"data":    updatedUser,
		})
	}
}

func DeleteUser(userService *services.UserService) gin.HandlerFunc {
	return func(c *gin.Context) {
		id := c.Param("id")
		
		err := userService.DeleteUser(id)
		if err != nil {
			c.JSON(http.StatusNotFound, gin.H{
				"success": false,
				"error":   gin.H{"message": "User not found"},
			})
			return
		}

		c.JSON(http.StatusOK, gin.H{
			"success": true,
			"message": "User deleted successfully",
		})
	}
}